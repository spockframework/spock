[[parallel-execution]]
= Parallel Execution
include::include.adoc[]
:xrefstyle: short

WARNING: This is an experimental feature for Spock and also relies on an experimental implementation in the JUnit Platform.

Parallel execution has the potential to reduce the overall test execution time.
The actual achievable reduction will heavily depend on the respective codebase and can vary wildly.

By default, Spock runs tests sequentially with a single thread.
As of 2.0 Spock supports parallel execution based on the JUnit Platform.
To enable parallel execution set the `runner.parallel.enabled` setting `true`.
See <<extensions.adoc#spock-configuration-file, Spock Configuration File>> for general information about this file.


.SpockConfig.groovy
[source,groovy,indent=0]
----
include::{sourcedir}/parallel/ParallelConfigDoc.groovy[tag=enable]
----

[[execution-modes]]
== Execution modes
Spock supports two execution modes `SAME_THREAD` and `CONCURRENT`.
You can define the execution mode explicitly for a specification or feature via the `@Execution` extension.
Otherwise, Spock will use the value of `defaultSpecificationExecutionMode` and `defaultExecutionMode` respectively.

* `defaultSpecificationExecutionMode` controls what execution mode a specification will use by default.
* `defaultExecutionMode` controls  what execution mode a feature and its iterations (if data driven) will use by default.

<<sequential-squential-execution>>

.Sequential Execution, either `runner.parallel.enabled=false` or `SAME_THREAD` Specifications, `SAME_THREAD` Tests
[plantuml,images/sequential-squential-execution,svg]
[[sequential-squential-execution]]
....
@startgantt
scale 2
[A.test1()] lasts 4 days
then [A.test2()] lasts 8 days
then [B.test1()] lasts 6 days
then [B.test2()] lasts 4 days
@endgantt
....

.`CONCURRENT` Specifications, `CONCURRENT` Tests
[plantuml,images/concurrent-concurrent-execution,svg]
[[concurrent-concurrent-execution]]
....
@startgantt
scale 2
[A.test1()] lasts 4 days
[A.test2()] lasts 8 days
[B.test1()] lasts 6 days
[B.test2()] lasts 4 days
@endgantt
....


.`CONCURRENT` Specifications, `SAME_THREAD` Tests
[plantuml,images/concurrent-sequential-execution,svg]
[[concurrent-sequential-execution]]
....
@startgantt
scale 2
[A.test1()] lasts 4 days
then [A.test2()] lasts 8 days
[B.test1()] lasts 6 days
then [B.test2()] lasts 4 days
@endgantt
....


.`SAME_THREAD` Specifications, `CONCURRENT` Tests
[plantuml,images/sequential-concurrent-execution,svg]
[[sequential-concurrent-execution]]
....
@startgantt
scale 2
[A.test1()] lasts 4 days
[A.test2()] lasts 8 days
[B.test1()] lasts 6 days and starts at [A.test2()]'s end
[B.test2()] lasts 4 days and starts at [A.test2()]'s end
@endgantt
....


== Execution Hierarchy

TODO: Explain the difference with inheritance of `@ExecutionMode` and also `@ResourceLock`.

[plantuml,images/execution-hierarchy-same-thread,svg]
....
@startwbs
skinparam shadowing false
* SpockEngine
** SpecA
*** TestA1
*** TestA2
** SpecB
*** TestB1
*** TestB2
**** TestB2[1]
**** TestB2[2]
@endwbs
....

[plantuml,images/execution-hierarchy-concurrent-sequential-execution,svg]
....

@startwbs
<style>
wbsDiagram {
  node {
    :depth(1) {
      BackgroundColor #CEFEE6
    }
  }

 .mexicoStyle * {
     BackgroundColor Red
     FontColor White
     RoundCorner 10
 }
}
</style>
skinparam shadowing false
* SpockEngine
** SpecA
*** TestA1
*** TestA2
** SpecB
*** TestB1
*** TestB2
**** TestB2[1]
**** TestB2[2]
@endwbs
....

[plantuml,images/execution-hierarchy-sequential-concurrent-execution,svg]
....

@startwbs
<style>
wbsDiagram {
  node {
    :depth(2) {
      BackgroundColor #CEFEE6
    }
    :depth(3) {
      BackgroundColor #CEFEE6
    }
  }
}
</style>
skinparam shadowing false
* SpockEngine
** SpecA
*** TestA1
*** TestA2
** SpecB
*** TestB1
*** TestB2
**** TestB2[1]
**** TestB2[2]
@endwbs
....

[plantuml,images/execution-hierarchy-concurrent-concurrent-execution,svg]
....

@startwbs
<style>
wbsDiagram {
  node {
    :depth(1) {
      BackgroundColor #CEFEE6
    }
    :depth(2) {
      BackgroundColor #CEFEE6
    }
    :depth(3) {
      BackgroundColor #CEFEE6
    }
  }
}
</style>
skinparam shadowing false
* SpockEngine
** SpecA
*** TestA1
*** TestA2
** SpecB
*** TestB1
*** TestB2
**** TestB2[1]
**** TestB2[2]
@endwbs
....

== Inheritance

[plantuml,images/execution-hierarchy-inheritance-feature-execution,svg]
....

@startwbs
<style>
wbsDiagram {
  .concurrent * {
      BackgroundColor #CEFEE6
  }
}
</style>
skinparam shadowing false
* SpockEngine
** SpecA
*** TestA1
*** @ExecutionMode(Concurrent)\nTestA2 <<concurrent>>
** SpecB
*** TestB1
*** @ExecutionMode(Concurrent)\nTestB2 <<concurrent>>
**** TestB2[1]
**** TestB2[2]
@endwbs
....

[plantuml,images/execution-hierarchy-inheritance-spec-execution,svg]
....

@startwbs
<style>
wbsDiagram {
  .concurrent * {
      BackgroundColor #CEFEE6
  }
}
</style>
skinparam shadowing false
* SpockEngine
** SpecA
*** TestA1
*** TestA2
** @ExecutionMode(Concurrent)\nTSpecB  <<concurrent>>
*** TestB1
*** TestB2
**** TestB2[1]
**** TestB2[2]
@endwbs
....
