<!DOCTYPE html>
<html lang="">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<meta name="author" content="Peter Niederwieser, Leonard Brünings, The Spock Framework Team">
<title>Interaction Based Testing</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<style>
  .includeSourceLinkerTable tr td:first-child {
    padding: 0;
  }
</style>
</head>
<body id="interaction-based-testing" class="article">
<div id="header">
<h1>Interaction Based Testing</h1>
<div class="details">
<span id="author" class="author">Peter Niederwieser, Leonard Brünings, The Spock Framework Team</span><br>
<span id="revnumber">version 2.4-SNAPSHOT</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Interaction-based testing is a design and testing technique that emerged in the Extreme Programming
(XP) community in the early 2000&#8217;s. Focusing on the behavior of objects rather than their state, it explores how
the object(s) under specification interact, by way of method calls, with their collaborators.</p>
</div>
<div class="paragraph">
<p>For example, suppose we have a <code>Publisher</code> that sends messages to its `Subscriber`s:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Publisher</span> {
  <span class="predefined-type">List</span>&lt;Subscriber&gt; subscribers = <span class="type">[]</span>
  <span class="type">int</span> messageCount = <span class="integer">0</span>
  <span class="type">void</span> send(<span class="predefined-type">String</span> message){
    subscribers*.receive(message)
    messageCount++
  }
}

<span class="type">interface</span> Subscriber {
  <span class="type">void</span> receive(<span class="predefined-type">String</span> message)
}

<span class="type">class</span> <span class="class">PublisherSpec</span> <span class="directive">extends</span> Specification {
  Publisher publisher = <span class="keyword">new</span> Publisher()
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L72" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>How are we going to test <code>Publisher</code>? With state-based testing, we can verify that the publisher keeps track of its
subscribers. The more interesting question, though, is whether a message sent by the publisher
is received by the subscribers. To answer this question, we need a special implementation of
<code>Subscriber</code> that listens in on the conversation between the publisher and its subscribers. Such an
implementation is called a <em>mock object</em>.</p>
</div>
<div class="paragraph">
<p>While we could certainly create a mock implementation of <code>Subscriber</code> by hand, writing and maintaining this code
can get unpleasant as the number of methods and complexity of interactions increases. This is where mocking frameworks
come in: They provide a way to describe the expected interactions between an object under specification and its
collaborators, and can generate mock implementations of collaborators that verify these expectations.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How Are Mock Implementations Generated?</div>
<div class="paragraph">
<p>Like most Java mocking frameworks, Spock uses
<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html">JDK dynamic proxies</a> (when mocking interfaces)
and <a href="https://bytebuddy.net/">Byte Buddy</a> or <a href="https://github.com/cglib/cglib">CGLIB</a> proxies (when mocking classes) to generate mock implementations at runtime.
Compared to implementations based on Groovy meta-programming, this has the advantage that it also works for testing Java code.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The Java world has no shortage of popular and mature mocking frameworks: <a href="https://www.jmock.org/">JMock</a>,
<a href="https://www.easymock.org">EasyMock</a>, <a href="https://mockito.org/">Mockito</a>, to name just a few.
Although each of these tools can be used together with Spock, we decided to roll our own mocking framework,
tightly integrated with Spock&#8217;s specification language. This decision was driven by the desire to leverage all of
Groovy&#8217;s capabilities to make interaction-based tests easier to write, more readable, and ultimately more fun.
We hope that by the end of this chapter, you will agree that we have achieved these goals.</p>
</div>
<div class="paragraph">
<p>Except where indicated, all features of Spock&#8217;s mocking framework work both for testing Java and Groovy code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_mock_objects"><a class="anchor" href="#_creating_mock_objects"></a><a class="link" href="#_creating_mock_objects">Creating Mock Objects</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mock objects are created with the <code>MockingApi.Mock()</code> method.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
Let&#8217;s create two mock subscribers:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> subscriber = Mock(Subscriber)
<span class="keyword">def</span> subscriber2 = Mock(Subscriber)</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L15" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Alternatively, the following Java-like syntax is supported, which may give better IDE support:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Subscriber subscriber = Mock()
Subscriber subscriber2 = Mock()</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L31" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here, the mock&#8217;s type is inferred from the variable type on the left-hand side of the assignment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the mock&#8217;s type is given on the left-hand side of the assignment, it&#8217;s permissible
(though not required) to omit it on the right-hand side.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mock objects literally implement (or, in the case of a class, extend) the type they stand in for. In other
words, in our example <code>subscriber</code> <em>is-a</em> <code>Subscriber</code>. Hence it can be passed to statically typed (Java)
code that expects this type.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_default_behavior_of_mock_objects"><a class="anchor" href="#_default_behavior_of_mock_objects"></a><a class="link" href="#_default_behavior_of_mock_objects">Default Behavior of Mock Objects</a></h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">Lenient vs. Strict Mocking Frameworks</div>
<div class="paragraph">
<p>Like Mockito, we firmly believe that a mocking framework should be lenient by default. This means that unexpected
method calls on mock objects (or, in other words, interactions that aren&#8217;t relevant for the test at hand) are allowed
and answered with a default response. Conversely, mocking frameworks like EasyMock and JMock are strict by default,
and throw an exception for every unexpected method call. While strictness enforces rigor, it can also lead
to over-specification, resulting in brittle tests that fail with every other internal code change. Spock&#8217;s mocking
framework makes it easy to describe only what&#8217;s relevant about an interaction, avoiding the over-specification trap.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Initially, mock objects have no behavior. Calling methods on them is allowed but has no effect other than returning
the default value for the method&#8217;s return type (<code>false</code>, <code>0</code>, or <code>null</code>). An exception are the <code>Object.equals</code>,
<code>Object.hashCode</code>, and <code>Object.toString</code> methods, which have the following default behavior: A mock object is only
equal to itself, has a unique hash code, and a string representation that includes the name of the type it represents.
This default behavior is overridable by stubbing the methods, which we will learn about in the <a href="#_stubbing">Stubbing</a> section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_injecting_mock_objects_into_code_under_specification"><a class="anchor" href="#_injecting_mock_objects_into_code_under_specification"></a><a class="link" href="#_injecting_mock_objects_into_code_under_specification">Injecting Mock Objects into Code Under Specification</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>After creating the publisher and its subscribers, we need to make the latter known to the former:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">PublisherSpec</span> <span class="directive">extends</span> Specification {
  Publisher publisher = <span class="keyword">new</span> Publisher()
  Subscriber subscriber = Mock()
  Subscriber subscriber2 = Mock()

  <span class="keyword">def</span> <span class="function">setup</span>() {
    publisher.subscribers &lt;&lt; subscriber <span class="comment">// &lt;&lt; is a Groovy shorthand for List.add()</span>
    publisher.subscribers &lt;&lt; subscriber2
  }</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L86" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We are now ready to describe the expected interactions between the two parties.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mocking"><a class="anchor" href="#_mocking"></a><a class="link" href="#_mocking">Mocking</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mocking is the act of describing (mandatory) interactions between the object under specification and its collaborators.
Here is an example:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">should send messages to all subscribers</span><span class="delimiter">&quot;</span></span>() {
  <span class="key">when</span>:
  publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)

  <span class="key">then</span>:
  <span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
  <span class="integer">1</span> * subscriber2.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L98" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Read out aloud: "When the publisher sends a 'hello' message, then both subscribers should receive that message exactly once."</p>
</div>
<div class="paragraph">
<p>When this feature method gets run, all invocations on mock objects that occur while executing the
<code>when</code> block will be matched against the interactions described in the <code>then:</code> block. If one of the interactions isn&#8217;t
satisfied, a (subclass of) <code>InteractionNotSatisfiedError</code> will be thrown. This verification happens automatically
and does not require any additional code.</p>
</div>
<div class="sect2">
<h3 id="_interactions"><a class="anchor" href="#_interactions"></a><a class="link" href="#_interactions">Interactions</a></h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Is an Interaction Just a Regular Method Invocation?</div>
<div class="paragraph">
<p>Not quite. While an interaction looks similar to a regular method invocation, it is simply a way to express which
method invocations are expected to occur. A good way to think of an interaction is as a regular expression
that all incoming invocations on mock objects are matched against. Depending on the circumstances, the interaction
may match zero, one, or multiple invocations.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a closer look at the <code>then:</code> block. It contains two <em>interactions</em>, each of which has four distinct
parts: a <em>cardinality</em>, a <em>target constraint</em>, a <em>method constraint</em>, and an <em>argument constraint</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1 * subscriber.receive("hello")
|   |          |       |
|   |          |       argument constraint
|   |          method constraint
|   target constraint
cardinality</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cardinality"><a class="anchor" href="#_cardinality"></a><a class="link" href="#_cardinality">Cardinality</a></h3>
<div class="paragraph">
<p>The cardinality of an interaction describes how often a method call is expected. It can either be a fixed number or
a range:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)      <span class="comment">// exactly one call</span>
<span class="integer">0</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)      <span class="comment">// zero calls</span>
(<span class="integer">1</span>..<span class="integer">3</span>) * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) <span class="comment">// between one and three calls (inclusive)</span>
(<span class="integer">1</span>.._) * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) <span class="comment">// at least one call</span>
(_..<span class="integer">3</span>) * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) <span class="comment">// at most three calls</span>
_ * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)      <span class="comment">// any number of calls, including zero</span>
                                     <span class="comment">// (rarely needed; see 'Strict Mocking')</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_target_constraint"><a class="anchor" href="#_target_constraint"></a><a class="link" href="#_target_constraint">Target Constraint</a></h3>
<div class="paragraph">
<p>The target constraint of an interaction describes which mock object is expected to receive the method call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) <span class="comment">// a call to 'subscriber'</span>
<span class="integer">1</span> * _.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)          <span class="comment">// a call to any mock object</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_method_constraint"><a class="anchor" href="#_method_constraint"></a><a class="link" href="#_method_constraint">Method Constraint</a></h3>
<div class="paragraph">
<p>The method constraint of an interaction describes which method is expected to be called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) <span class="comment">// a method named 'receive'</span>
<span class="integer">1</span> * subscriber.<span class="regexp"><span class="delimiter">/</span><span class="content">r.*e</span><span class="delimiter">/</span></span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// a method whose name matches the given regular expression</span>
                                <span class="comment">// (here: method name starts with 'r' and ends in 'e')</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When expecting a call to a getter method, Groovy property syntax <em>can</em> be used instead of method syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.status <span class="comment">// same as: 1 * subscriber.getStatus()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When expecting a call to a setter method, only method syntax can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.setStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>) <span class="comment">// NOT: 1 * subscriber.status = &quot;ok&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_argument_constraints"><a class="anchor" href="#_argument_constraints"></a><a class="link" href="#_argument_constraints">Argument Constraints</a></h3>
<div class="paragraph">
<p>The argument constraints of an interaction describe which method arguments are expected:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)        <span class="comment">// an argument that is equal to the String &quot;hello&quot;</span>
<span class="integer">1</span> * subscriber.receive(!<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)       <span class="comment">// an argument that is unequal to the String &quot;hello&quot;</span>
<span class="integer">1</span> * subscriber.receive()               <span class="comment">// the empty argument list (would never match in our example)</span>
<span class="integer">1</span> * subscriber.receive(_)              <span class="comment">// any single argument (including null)</span>
<span class="integer">1</span> * subscriber.receive(*_)             <span class="comment">// any argument list (including the empty argument list)</span>
<span class="integer">1</span> * subscriber.receive(!<span class="predefined-constant">null</span>)          <span class="comment">// any non-null argument</span>
<span class="integer">1</span> * subscriber.receive(_ <span class="keyword">as</span> <span class="predefined-type">String</span>)    <span class="comment">// any non-null argument that is-a String</span>
<span class="integer">1</span> * subscriber.receive(endsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">lo</span><span class="delimiter">&quot;</span></span>)) <span class="comment">// an argument matching the given Hamcrest matcher</span>
                                       <span class="comment">// a String argument ending with &quot;lo&quot; in this case</span>
<span class="integer">1</span> * subscriber.receive({ <span class="local-variable">it</span>.size() &gt; <span class="integer">3</span> &amp;&amp; <span class="local-variable">it</span>.contains(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>) })
<span class="comment">// an argument that satisfies the given predicate, meaning that</span>
<span class="comment">// code argument constraints need to return true of false</span>
<span class="comment">// depending on whether they match or not</span>
<span class="comment">// (here: message length is greater than 3 and contains the character a)</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L154" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Argument constraints work as expected for methods with multiple arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * process.invoke(<span class="string"><span class="delimiter">&quot;</span><span class="content">ls</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">-a</span><span class="delimiter">&quot;</span></span>, _, !<span class="predefined-constant">null</span>, { [<span class="string"><span class="delimiter">&quot;</span><span class="content">abcdefghiklmnopqrstuwx1</span><span class="delimiter">&quot;</span></span>].contains(<span class="local-variable">it</span>) })</code></pre>
</div>
</div>
<div class="paragraph">
<p>When dealing with vararg methods, vararg syntax can also be used in the corresponding interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">interface</span> VarArgSubscriber {
    <span class="type">void</span> receive(<span class="predefined-type">String</span>... messages)
}

...

subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Spock Deep Dive: Groovy Varargs</div>
<div class="paragraph">
<p>Groovy allows any method whose last parameter has an array type to be called in vararg style.
Consequently, vararg syntax can also be used in interactions matching such methods.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_equality_constraint"><a class="anchor" href="#_equality_constraint"></a><a class="link" href="#_equality_constraint">Equality Constraint</a></h4>
<div class="paragraph">
<p>The equality constraint uses groovy equality to check the argument, i.e, <code>argument == constraint</code>. You can use</p>
</div>
<div class="ulist">
<ul>
<li>
<p>any literal <code>1 * check('string')</code> / <code>1 * check(1)</code> / <code>1 * check(null)</code>,</p>
</li>
<li>
<p>a variable <code>1 * check(var)</code>,</p>
</li>
<li>
<p>a list or map literal <code>1 * check([1])</code> / <code>1 * check([foo: 'bar'])</code>,</p>
</li>
<li>
<p>an object <code>1 * check(new Person('sam'))</code>,</p>
</li>
<li>
<p>or the result of a method call <code>1 * check(person())</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>as an equality constraint.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hamcrest_constraint"><a class="anchor" href="#_hamcrest_constraint"></a><a class="link" href="#_hamcrest_constraint">Hamcrest Constraint</a></h4>
<div class="paragraph">
<p>A variation of the equality constraint, if the constraint object is a Hamcrest matcher, then it will use that matcher
to check the argument.</p>
</div>
</div>
<div class="sect3">
<h4 id="_wildcard_constraint"><a class="anchor" href="#_wildcard_constraint"></a><a class="link" href="#_wildcard_constraint">Wildcard Constraint</a></h4>
<div class="paragraph">
<p>The wildcard constraint will match any argument <code>null</code> or otherwise. It is the <code><em></code>, i.e. <code>1 * subscriber.receive(</em>)</code>.
There is also the spread wildcard constraint <code>*_</code> which matches any number of arguments <code>1 * subscriber.receive(*_)</code> including none.</p>
</div>
</div>
<div class="sect3">
<h4 id="_code_constraint"><a class="anchor" href="#_code_constraint"></a><a class="link" href="#_code_constraint">Code Constraint</a></h4>
<div class="paragraph">
<p>The code constraint is the most versatile of all. It is a groovy closure that gets the argument as its parameter.
The closure is treated as an condition block, so it behaves like a <code>then</code> block, i.e., every line is treated as an implicit assertion.
It can emulate all but the spread wildcard constraint, however it is suggested to use the simpler constraints where possible.
You can do multiple assertions, call methods for assertions, or use <code>with</code>/<code>verifyAll</code>.</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * list.add({
  verifyAll(<span class="local-variable">it</span>, Person) {
    firstname == <span class="string"><span class="delimiter">'</span><span class="content">William</span><span class="delimiter">'</span></span>
    lastname == <span class="string"><span class="delimiter">'</span><span class="content">Kirk</span><span class="delimiter">'</span></span>
    age == <span class="integer">45</span>
  }
})</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L303" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_negating_constraint"><a class="anchor" href="#_negating_constraint"></a><a class="link" href="#_negating_constraint">Negating Constraint</a></h4>
<div class="paragraph">
<p>The negating constraint <code>!</code> is a compound constraint, i.e. it needs to be combined with another constraint to work.
It inverts the result of the nested constraint, e.g, <code>1 * subscriber.receive(!null)</code> is the combination of
an equality constraint checking for null and then the negating constraint inverting the result, turning it into not null.</p>
</div>
<div class="paragraph">
<p>Although it can be combined with any other constraint it does not always make sense, e.g., <code>1 * subscriber.receive(!_)</code> will match nothing.
Also keep in mind that the diagnostics for a non matching negating constraint will just be that the inner
constraint did match, without any more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_type_constraint"><a class="anchor" href="#_type_constraint"></a><a class="link" href="#_type_constraint">Type Constraint</a></h4>
<div class="paragraph">
<p>The type constraint checks for the type/class of the argument, like the negating constraint it is also a compound constraint.
It usually written as <code>_ as Type</code>, which is a combination of the wildcard constraint and the type constraint.
You can combined it with other constraints as well, <code>1 * subscriber.receive({ it.contains('foo')} as String)</code> will assert that it is
a <code>String</code> before executing the code constraint to check if it contains <code>foo</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_matching_any_method_call"><a class="anchor" href="#_matching_any_method_call"></a><a class="link" href="#_matching_any_method_call">Matching Any Method Call</a></h3>
<div class="paragraph">
<p>Sometimes it can be useful to match "anything", in some sense of the word:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber._(*_)     <span class="comment">// any method on subscriber, with any argument list</span>
<span class="integer">1</span> * subscriber._         <span class="comment">// shortcut for and preferred over the above</span>

<span class="integer">1</span> * _._                  <span class="comment">// any method call on any mock object</span>
<span class="integer">1</span> * _                    <span class="comment">// shortcut for and preferred over the above</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L250" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although <code>(_.._) * _._(*_) &gt;&gt; _</code> is a valid interaction declaration,
it is neither good style nor particularly useful.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_strict_mocking"><a class="anchor" href="#_strict_mocking"></a><a class="link" href="#_strict_mocking">Strict Mocking</a></h3>
<div class="paragraph">
<p>Now, when would matching any method call be useful? A good example is <em>strict mocking</em>,
a style of mocking where no interactions other than those explicitly declared are allowed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">when</span>:
publisher.publish(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) <span class="comment">// demand one 'receive' call on 'subscriber'</span>
_ * auditing._                  <span class="comment">// allow any interaction with 'auditing'</span>
<span class="integer">0</span> * _                           <span class="comment">// don't allow any other interaction</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>0 *</code> only makes sense as the last interaction of a <code>then:</code> block or method. Note the
use of <code>_ *</code> (any number of calls), which allows any interaction with the auditing component.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>_ *</code> is only meaningful in the context of strict mocking. In particular, it is never necessary
when <a href="#_stubbing">Stubbing</a> an invocation. For example, <code>_ * auditing.record(<em>) &gt;&gt; "ok"</code>
can (and should!) be simplified to <code>auditing.record(</em>) &gt;&gt; "ok"</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_where_to_declare_interactions"><a class="anchor" href="#_where_to_declare_interactions"></a><a class="link" href="#_where_to_declare_interactions">Where to Declare Interactions</a></h3>
<div class="paragraph">
<p>So far, we declared all our interactions in a <code>then:</code> block. This often results in a spec that reads naturally.
However, it is also permissible to put interactions anywhere <em>before</em> the <code>when:</code> block that is supposed to satisfy
them. In particular, this means that interactions can be declared in a <code>setup</code> method. Interactions can also be
declared in any "helper" instance method of the same specification class.</p>
</div>
<div class="paragraph">
<p>When an invocation on a mock object occurs, it is matched against interactions in the interactions' declared order.
If an invocation matches multiple interactions, the earliest declared interaction that hasn&#8217;t reached its upper
invocation limit will win. There is one exception to this rule: Interactions declared in a <code>then:</code> block are
matched against before any other interactions. This allows to override interactions declared in, say, a <code>setup</code>
method with interactions declared in a <code>then:</code> block.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Spock Deep Dive: How Are Interactions Recognized?</div>
<div class="paragraph">
<p>In other words, what makes an expression an interaction declaration, rather than, say, a regular method call?
Spock uses a simple syntactic rule to recognize interactions: If an expression is in statement position
and is either a multiplication (<code>*</code>) or a right-shift (<code>&gt;&gt;</code>, <code>&gt;&gt;&gt;</code>) operation, then it is considered
an interaction and will be parsed accordingly. Such an expression would have little to no value in statement
position, so changing its meaning works out fine. Note how the operations correspond to the syntax for declaring
a cardinality (when mocking) or a response generator (when stubbing). Either of them must always be present;
<code>foo.bar()</code> alone will never be considered an interaction.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="declaring-interactions-at-creation-time"><a class="anchor" href="#declaring-interactions-at-creation-time"></a><a class="link" href="#declaring-interactions-at-creation-time">Declaring Interactions at Mock Creation Time</a></h3>
<div class="paragraph">
<p>If a mock has a set of "base" interactions that don&#8217;t vary, they can be declared right at mock creation time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Subscriber subscriber = Mock {
   <span class="integer">1</span> * receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
   <span class="integer">1</span> * receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature is particularly attractive for <a href="#_stubbing">Stubbing</a> and with dedicated <a href="#Stubs">Stubs</a>. Note that the
interactions don&#8217;t (and cannot <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>) have a target constraint; it&#8217;s clear from the context which mock
object they belong to.</p>
</div>
<div class="paragraph">
<p>Interactions can also be declared when initializing an instance field with a mock:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">MySpec</span> <span class="directive">extends</span> Specification {
    Subscriber subscriber = Mock {
        <span class="integer">1</span> * receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
        <span class="integer">1</span> * receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_grouping_interactions_with_same_target"><a class="anchor" href="#_grouping_interactions_with_same_target"></a><a class="link" href="#_grouping_interactions_with_same_target">Grouping Interactions with Same Target</a></h3>
<div class="paragraph">
<p>Interactions sharing the same target can be grouped in a <code>Specification.with</code> block. Similar to
<a href="#declaring-interactions-at-creation-time">Declaring Interactions at Mock Creation Time</a>, this makes it unnecessary
to repeat the target constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">with(subscriber) {
    <span class="integer">1</span> * receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
    <span class="integer">1</span> * receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>with</code> block can also be used for grouping conditions with the same target.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mixing_interactions_and_conditions"><a class="anchor" href="#_mixing_interactions_and_conditions"></a><a class="link" href="#_mixing_interactions_and_conditions">Mixing Interactions and Conditions</a></h3>
<div class="paragraph">
<p>A <code>then:</code> block may contain both interactions and conditions. Although not strictly required, it is customary
to declare interactions before conditions:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
publisher.messageCount == <span class="integer">1</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L110" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Read out aloud: "When the publisher sends a 'hello' message, then the subscriber should receive the message exactly
once, and the publisher&#8217;s message count should be one."</p>
</div>
</div>
<div class="sect2">
<h3 id="_explicit_interaction_blocks"><a class="anchor" href="#_explicit_interaction_blocks"></a><a class="link" href="#_explicit_interaction_blocks">Explicit Interaction Blocks</a></h3>
<div class="paragraph">
<p>Internally, Spock must have full information about expected interactions <em>before</em> they take place.
So how is it possible for interactions to be declared in a <code>then:</code> block?
The answer is that under the hood, Spock moves interactions declared in a <code>then:</code> block to immediately
before the preceding <code>when:</code> block. In most cases this works out just fine, but sometimes it can lead to problems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="keyword">def</span> message = <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>
<span class="integer">1</span> * subscriber.receive(message)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have introduced a variable for the expected argument. (Likewise, we could have introduced a variable
for the cardinality.) However, Spock isn&#8217;t smart enough (huh?) to tell that the interaction is intrinsically
linked to the variable declaration. Hence it will just move the interaction, which will cause a
<code>MissingPropertyException</code> at runtime.</p>
</div>
<div class="paragraph">
<p>One way to solve this problem is to move (at least) the variable declaration to before the <code>when:</code>
block. (Fans of <a href="data_driven_testing.html#data-driven-testing">Data Driven Testing</a> might move the variable into a <code>where:</code> block.)
In our example, this would have the added benefit that we could use the same variable for sending the message.</p>
</div>
<div class="paragraph">
<p>Another solution is to be explicit about the fact that variable declaration and interaction belong together:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
interaction {
  <span class="keyword">def</span> message = <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>
  <span class="integer">1</span> * subscriber.receive(message)
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L121" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Since an <code>MockingApi.interaction</code> block is always moved in its entirety, the code now works as intended.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scope_of_interactions"><a class="anchor" href="#_scope_of_interactions"></a><a class="link" href="#_scope_of_interactions">Scope of Interactions</a></h3>
<div class="paragraph">
<p>Interactions declared in a <code>then:</code> block are scoped to the preceding <code>when:</code> block:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>)

<span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">message2</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message2</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L134" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This makes sure that <code>subscriber</code> receives <code>"message1"</code> during execution of the first <code>when:</code> block,
and <code>"message2"</code> during execution of the second <code>when:</code> block.</p>
</div>
<div class="paragraph">
<p>Interactions declared outside a <code>then:</code> block are active from their declaration until the end of the
containing feature method.</p>
</div>
<div class="paragraph">
<p>Interactions are always scoped to a particular feature method. Hence they cannot be declared in a static method,
<code>setupSpec</code> method, or <code>cleanupSpec</code> method. Likewise, mock objects should not be stored in static or <code>@Shared</code>
fields.</p>
</div>
</div>
<div class="sect2">
<h3 id="_verification_of_interactions"><a class="anchor" href="#_verification_of_interactions"></a><a class="link" href="#_verification_of_interactions">Verification of Interactions</a></h3>
<div class="paragraph">
<p>There are two main ways in which a mock-based test can fail: An interaction can match more invocations than
allowed, or it can match fewer invocations than required. The former case is detected right when the invocation
happens, and causes a <code>TooManyInvocationsError</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Too many invocations for:

2 * subscriber.receive(_) (3 invocations)</pre>
</div>
</div>
<div id="ShowAllMatchingInvocations" class="paragraph">
<p>To make it easier to diagnose why too many invocations matched, Spock will show all invocations matching
the interaction in question:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Matching invocations (ordered by last occurrence):

2 * subscriber.receive("hello")   &lt;-- this triggered the error
1 * subscriber.receive("goodbye")</pre>
</div>
</div>
<div class="paragraph">
<p>According to this output, one of the <code>receive("hello")</code> calls triggered the <code>TooManyInvocationsError</code>.
Note that because indistinguishable calls like the two invocations of <code>subscriber.receive("hello")</code> are aggregated
into a single line of output, the first <code>receive("hello")</code> may well have occurred before the <code>receive("goodbye")</code>.</p>
</div>
<div class="paragraph">
<p>The second case (fewer invocations than required) can only be detected once execution of the <code>when</code> block has completed.
(Until then, further invocations may still occur.) It causes a <code>TooFewInvocationsError</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Too few invocations for:

1 * subscriber.receive("hello") (0 invocations)</pre>
</div>
</div>
<div class="paragraph">
<p>Note that it doesn&#8217;t matter whether the method was not called at all, the same method was called with different arguments,
the same method was called on a different mock object, or a different method was called "instead" of this one;
in either case, a <code>TooFewInvocationsError</code> error will occur.</p>
</div>
<div id="ShowUnmatchedInvocations" class="paragraph">
<p>To make it easier to diagnose what happened "instead" of a missing invocation, Spock will show all
invocations that didn&#8217;t match any interaction, ordered by their similarity with the interaction in question.
In particular, invocations that match everything but the interaction&#8217;s arguments will be shown first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Unmatched invocations (ordered by similarity):

<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)
<span class="integer">1</span> * subscriber2.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invocation_order"><a class="anchor" href="#_invocation_order"></a><a class="link" href="#_invocation_order">Invocation Order</a></h3>
<div class="paragraph">
<p>Often, the exact method invocation order isn&#8217;t relevant and may change over time. To avoid over-specification,
Spock defaults to allowing any invocation order, provided that the specified interactions are eventually satisfied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">then</span>:
<span class="integer">2</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, any of the invocation sequences <code>"hello"</code> <code>"hello"</code> <code>"goodbye"</code>, <code>"hello"</code> <code>"goodbye"</code> <code>"hello"</code>, and
<code>"goodbye"</code> <code>"hello"</code> <code>"hello"</code> will satisfy the specified interactions.</p>
</div>
<div class="paragraph">
<p>In those cases where invocation order matters, you can impose an order by splitting up interactions into
multiple <code>then:</code> blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">then</span>:
<span class="integer">2</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">goodbye</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Spock will verify that both <code>"hello"</code>'s are received before the <code>"goodbye"</code>.
In other words, invocation order is enforced <em>between</em> but not <em>within</em> <code>then:</code> blocks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Splitting up a <code>then:</code> block with <code>and:</code> does not impose any ordering, as <code>and:</code>
is only meant for documentation purposes and doesn&#8217;t carry any semantics.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_classes"><a class="anchor" href="#_mocking_classes"></a><a class="link" href="#_mocking_classes">Mocking Classes</a></h3>
<div class="paragraph">
<p>Besides interfaces, Spock also supports mocking of classes and interfaces with
different <a href="extensions.html#mock-makers">mock makers</a>.
Mocking classes works just like mocking interfaces, but you may need to put
additional runtime dependencies on the class path, depending on the used mock maker.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mock_instance_construction"><a class="anchor" href="#_mock_instance_construction"></a><a class="link" href="#_mock_instance_construction">Mock Instance Construction</a></h3>
<div class="paragraph">
<p>When using for example</p>
</div>
<div class="ulist">
<ul>
<li>
<p>normal <code>Mock</code>s or <code>Stub</code>s or</p>
</li>
<li>
<p><code>Spy</code>s that are configured with <code>useObjenesis: true</code> or</p>
</li>
<li>
<p><code>Spy</code>s that spy on a concrete instance like <code>Spy(myInstance)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>it is necessary to put <code>org.objenesis:objenesis</code> 3.0+ on the class path, except for classes with accessible
no-arg constructor or configured <code>constructorArgs</code> unless the constructor call should not be done,
for example to avoid unwanted side effects.</p>
</div>
<div class="paragraph">
<p>If the library is missing from the class path, Spock will gently let you know.</p>
</div>
</div>
<div class="sect2">
<h3 id="_selecting_a_mock_maker"><a class="anchor" href="#_selecting_a_mock_maker"></a><a class="link" href="#_selecting_a_mock_maker">Selecting a Mock Maker</a></h3>
<div class="paragraph">
<p>The different <a href="extensions.html#mock-makers">mock makers</a> have different capabilities and drawbacks.
You can manually select the used mock maker for the mocked object,
by specifying an <code>IMockMakerSettings</code> instance as the <code>mockMaker</code> mock option.</p>
</div>
<div class="paragraph">
<p>The class <code>spock.mock.MockMakers</code> provides constants and methods for the built-in mock makers.</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> subscriber = Mock(<span class="key">mockMaker</span>: MockMakers.byteBuddy, Subscriber)</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/MockMakerDocSpec.groovy#L28" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/MockMakerDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This will use the <code>byte-buddy</code> mock maker to create the <code>subscriber</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stubbing"><a class="anchor" href="#_stubbing"></a><a class="link" href="#_stubbing">Stubbing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stubbing is the act of making collaborators respond to method calls in a certain way. When stubbing
a method, you don&#8217;t care if and how many times the method is going to be called; you just want it to
return some value, or perform some side effect, <em>whenever</em> it gets called.</p>
</div>
<div class="paragraph">
<p>For the sake of the following examples, let&#8217;s modify the <code>Subscriber</code>'s <code>receive</code> method
to return a status code that tells if the subscriber was able to process a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">interface</span> Subscriber {
    <span class="predefined-type">String</span> receive(<span class="predefined-type">String</span> message)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s make the <code>receive</code> method return <code>"ok"</code> on every invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Read out aloud: "<em>Whenever</em> the subscriber receives a message, <em>make</em> it respond with 'ok'."</p>
</div>
<div class="paragraph">
<p>Compared to a mocked interaction, a stubbed interaction has no cardinality on the left end, but adds a
<em>response generator</em> on the right end:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>subscriber.receive(_) &gt;&gt; "ok"
|          |       |     |
|          |       |     response generator
|          |       argument constraint
|          method constraint
target constraint</pre>
</div>
</div>
<div class="paragraph">
<p>A stubbed interaction can be declared in the usual places: either inside a <code>then:</code> block, or anywhere before a
<code>when:</code> block. (See <a href="#_where_to_declare_interactions">Where to Declare Interactions</a> for the details.) If a mock object is only used for stubbing,
it&#8217;s common to declare interactions <a href="#declaring-interactions-at-creation-time">at mock creation time</a> or in a
<code>given:</code> block.</p>
</div>
<div class="sect2">
<h3 id="_returning_fixed_values"><a class="anchor" href="#_returning_fixed_values"></a><a class="link" href="#_returning_fixed_values">Returning Fixed Values</a></h3>
<div class="paragraph">
<p>We have already seen the use of the right-shift (<code>&gt;&gt;</code>) operator to return a fixed value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To return different values for different invocations, use multiple interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>
subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message2</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return <code>"ok"</code> whenever <code>"message1"</code> is received, and <code>"fail"</code> whenever
<code>"message2"</code> is received. There is no limit as to which values can be returned, provided they are
compatible with the method&#8217;s declared return type.</p>
</div>
</div>
<div class="sect2">
<h3 id="_returning_sequences_of_values"><a class="anchor" href="#_returning_sequences_of_values"></a><a class="link" href="#_returning_sequences_of_values">Returning Sequences of Values</a></h3>
<div class="paragraph">
<p>To return different values on successive invocations, use the triple-right-shift (<code>&gt;&gt;&gt;</code>) operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt;&gt; [<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return <code>"ok"</code> for the first invocation, <code>"error"</code> for the second and third invocation,
and <code>"ok"</code> for all remaining invocations. The right-hand side must be a value that Groovy knows how to iterate over;
in this example, we&#8217;ve used a plain list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_computing_return_values"><a class="anchor" href="#_computing_return_values"></a><a class="link" href="#_computing_return_values">Computing Return Values</a></h3>
<div class="paragraph">
<p>To compute a return value based on the method&#8217;s argument, use the the right-shift (<code>&gt;&gt;</code>) operator together with a closure.
If the closure declares a single untyped parameter, it gets passed the method&#8217;s argument list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; { args -&gt; args[<span class="integer">0</span>].size() &gt; <span class="integer">3</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>"ok"</code> gets returned if the message is more than three characters long, and <code>"fail"</code> otherwise.</p>
</div>
<div class="paragraph">
<p>In most cases it would be more convenient to have direct access to the method&#8217;s arguments. If the closure declares more
than one parameter or a single <em>typed</em> parameter, method arguments will be mapped one-by-one to closure
parameters:<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; { <span class="predefined-type">String</span> message -&gt; message.size() &gt; <span class="integer">3</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This response generator behaves the same as the previous one, but is arguably more readable.</p>
</div>
<div class="paragraph">
<p>If you find yourself in need of more information about a method invocation than its arguments, have a look at
<code>org.spockframework.mock.IMockInvocation</code>. All methods declared in this interface are available inside the closure,
without a need to prefix them. (In Groovy terminology, the closure <em>delegates</em> to an instance of <code>IMockInvocation</code>.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_performing_side_effects"><a class="anchor" href="#_performing_side_effects"></a><a class="link" href="#_performing_side_effects">Performing Side Effects</a></h3>
<div class="paragraph">
<p>Sometimes you may want to do more than just computing a return value. A typical example is
throwing an exception. Again, closures come to the rescue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">InternalError</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ouch</span><span class="delimiter">&quot;</span></span>) }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the closure can contain more code, for example a <code>println</code> statement. It
will get executed every time an incoming invocation matches the interaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_chaining_method_responses"><a class="anchor" href="#_chaining_method_responses"></a><a class="link" href="#_chaining_method_responses">Chaining Method Responses</a></h3>
<div class="paragraph">
<p>Method responses can be chained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt;&gt; [<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>] &gt;&gt; { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">InternalError</span>() } &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return <code>"ok", "fail", "ok"</code> for the first three invocations, throw <code>InternalError</code>
for the fourth invocations, and return <code>ok</code> for any further invocation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_returning_a_default_response"><a class="anchor" href="#_returning_a_default_response"></a><a class="link" href="#_returning_a_default_response">Returning a default response</a></h3>
<div class="paragraph">
<p>If you don&#8217;t really care what you return, but you must return a non-null value, you can use <code>_</code>.
This will use the same logic to compute a response as <code>Stub</code> (see <a href="#Stubs">Stubs</a>), so it is only really useful for <code>Mock</code> and <code>Spy</code> instances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; _</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can of course use this with chaining as well. Here it might be useful for <code>Stub</code> instances as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt;&gt; [<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span>] &gt;&gt; _ &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An application of this is to let a <code>Mock</code> behave like a <code>Stub</code>, but still be able to do assertions.
The default response will return the mock itself, if the return type of the method is assignable from the mock type (excluding object).
This is useful when dealing with fluent APIs, like builders, which are otherwise really painful to mock.</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
ThingBuilder builder = Mock() {
  _ &gt;&gt; _
}

<span class="key">when</span>:
Thing thing = builder
  .id(<span class="string"><span class="delimiter">&quot;</span><span class="content">id-42</span><span class="delimiter">&quot;</span></span>)
  .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">spock</span><span class="delimiter">&quot;</span></span>)
  .weight(<span class="integer">100</span>)
  .build()

<span class="key">then</span>:
<span class="integer">1</span> * builder.build() &gt;&gt; <span class="keyword">new</span> Thing(<span class="key">id</span>: <span class="string"><span class="delimiter">'</span><span class="content">id-1337</span><span class="delimiter">'</span></span>)
thing.id == <span class="string"><span class="delimiter">'</span><span class="content">id-1337</span><span class="delimiter">'</span></span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/BuilderExampleSpec.groovy#L11" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/BuilderExampleSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>_ &gt;&gt; _</code> instructs the mock to return the default response for all interactions.
However, interactions defined in the <code>then</code> block will have precedence over the interactions defined in the <code>given</code> block,
this lets us override and assert the interaction we actually care about.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_combining_mocking_and_stubbing"><a class="anchor" href="#_combining_mocking_and_stubbing"></a><a class="link" href="#_combining_mocking_and_stubbing">Combining Mocking and Stubbing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mocking and stubbing go hand-in-hand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message2</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When mocking and stubbing the same method call, they have to happen in the same interaction.
In particular, the following Mockito-style splitting of stubbing and mocking into two separate
statements will <em>not</em> work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>

<span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">1</span> * subscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As explained in <a href="#_where_to_declare_interactions">Where to Declare Interactions</a>, the <code>receive</code> call will first get matched against
the interaction in the <code>then:</code> block. Since that interaction doesn&#8217;t specify a response, the default
value for the method&#8217;s return type (<code>null</code> in this case) will be returned. (This is just another
facet of Spock&#8217;s lenient approach to mocking.). Hence, the interaction in the <code>given:</code> block will never
get a chance to match.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Mocking and stubbing of the same method call has to happen in the same interaction.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="OtherKindsOfMockObjects"><a class="anchor" href="#OtherKindsOfMockObjects"></a><a class="link" href="#OtherKindsOfMockObjects">Other Kinds of Mock Objects</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, we have created mock objects with the <code>MockingApi.Mock</code> method. Aside from
this method, the <code>MockingApi</code> class provides a couple of other factory methods for creating
more specialized kinds of mock objects.</p>
</div>
<div class="sect2">
<h3 id="Stubs"><a class="anchor" href="#Stubs"></a><a class="link" href="#Stubs">Stubs</a></h3>
<div class="paragraph">
<p>A <em>stub</em> is created with the <code>MockingApi.Stub</code> factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Subscriber subscriber = <span class="predefined-type">Stub</span>()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas a mock can be used both for stubbing and mocking, a stub can only be used for stubbing.
Limiting a collaborator to a stub communicates its role to the readers of the specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a stub invocation matches a <em>mandatory</em> interaction (like <code>1 * foo.bar()</code>), an <code>InvalidSpecException</code> is thrown.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Like a mock, a stub allows unexpected invocations. However, the values returned by a stub in such cases are more ambitious:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For primitive types, the primitive type&#8217;s default value is returned.</p>
</li>
<li>
<p>For non-primitive numerical values (such as <code>BigDecimal</code>), zero is returned.</p>
</li>
<li>
<p>If the value is assignable from the stub instance, then the instance is returned (e.g. builder pattern)</p>
</li>
<li>
<p>For non-numerical values, an "empty" or "dummy" object is returned. This could mean an empty String, an empty collection,
an object constructed from its default constructor, or another stub returning default values.
See class <code>org.spockframework.mock.EmptyOrDummyResponse</code> for the details.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the response type of the method is a final class or if it requires a class-mocking library and cglib or ByteBuddy
      are not available, then the "dummy" object creation will fail with a <code>CannotCreateMockException</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A stub often has a fixed set of interactions, which makes
<a href="#declaring-interactions-at-creation-time">declaring interactions at mock creation time</a> particularly attractive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Subscriber subscriber = <span class="predefined-type">Stub</span> {
    receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message1</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>
    receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message2</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Spies"><a class="anchor" href="#Spies"></a><a class="link" href="#Spies">Spies</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <em>spy</em> is created with the <code>MockingApi.Spy</code> factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">SubscriberImpl subscriber = Spy(<span class="key">constructorArgs</span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>A spy is always based on a real object. Hence you must provide a class type rather
than an interface type, along with any constructor arguments for the type.
If no constructor arguments are provided, the type&#8217;s no-arg constructor will be used.</p>
</div>
<div class="paragraph">
<p>If the given constructor arguments lead to an ambiguity, you can cast the constructor
arguments as usual using <code>as</code> or Java-style cast. If the testee for example has
one constructor with a <code>String</code> parameter and one with a <code>Pattern</code> parameter
and you want <code>null</code> as <code>constructorArg</code>:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">SubscriberImpl subscriber = Spy(<span class="key">constructorArgs</span>: [<span class="predefined-constant">null</span> <span class="keyword">as</span> <span class="predefined-type">String</span>])
SubscriberImpl subscriber2 = Spy(<span class="key">constructorArgs</span>: [(<span class="predefined-type">Pattern</span>) <span class="predefined-constant">null</span>])</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy#L46" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/InteractionDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You may also create a spy from an instantiated object. This may be useful in cases
where you do not have full control over the instantiation of types you are interested
in spying. (For example when testing within a Dependency Injection framework such as
Spring or Guice.)</p>
</div>
<div class="paragraph">
<p>Method calls on a spy are automatically delegated to the real object. Likewise, values
returned from the real object&#8217;s methods are passed back to the caller via the spy.</p>
</div>
<div class="paragraph">
<p>After creating a spy, you can listen in on the conversation between the caller and the real object underlying the spy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="integer">1</span> * subscriber.receive(_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apart from making sure that <code>receive</code> gets called exactly once,
the conversation between the publisher and the <code>SubscriberImpl</code> instance underlying the spy remains unaltered.</p>
</div>
<div class="paragraph">
<p>When stubbing a method on a spy, the real method no longer gets called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of calling <code>SubscriberImpl.receive</code>, the <code>receive</code> method will now simply return <code>"ok"</code>.</p>
</div>
<div class="paragraph">
<p>Sometimes, it is desirable to both execute some code <em>and</em> delegate to the real method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subscriber.receive(_) &gt;&gt; { <span class="predefined-type">String</span> message -&gt; callRealMethod(); message.size() &gt; <span class="integer">3</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use <code>callRealMethod()</code> to delegate the method invocation to the real object.
Note that we don&#8217;t have to pass the <code>message</code> argument along; this is taken care of automatically. <code>callRealMethod()</code>
returns the real invocation&#8217;s result, but in this example we opted to return our own result instead.
If we had wanted to pass a different message to the real method, we could have used <code>callRealMethodWithArgs("changed message")</code>.</p>
</div>
<div class="paragraph">
<p>Please note that while semantically both <code>callRealMethod()</code> and <code>callRealMethodWithArgs(&#8230;&#8203;)</code> only make sense with spies,
technically you can also call these methods on mock or stub objects, kind of turning them into (pseudo) spy objects
"through the backdoor". The only precondition is that the mocked/stubbed object actually has a real method implementation,
i.e. for interface mocks there must be a default method, for class mocks there must be a (non-abstract) original method.</p>
</div>
</div>
<div class="sect2">
<h3 id="PartialMocks"><a class="anchor" href="#PartialMocks"></a><a class="link" href="#PartialMocks">Partial Mocks</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spies can also be used as partial mocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// this is now the object under specification, not a collaborator</span>
MessagePersister persister = Spy {
  <span class="comment">// stub a call on the same object</span>
  isPersistable(_) &gt;&gt; <span class="predefined-constant">true</span>
}

<span class="key">when</span>:
persister.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">msg</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="comment">// demand a call on the same object</span>
<span class="integer">1</span> * persister.persist(<span class="string"><span class="delimiter">&quot;</span><span class="content">msg</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MockingStaticMethods"><a class="anchor" href="#MockingStaticMethods"></a><a class="link" href="#MockingStaticMethods">Mocking Static Methods</a></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spock supports two ways of mocking static methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SpyStatic()</code> static mocks: Works with Java and Groovy, but requires a mock maker supporting this, e.g. <a href="extensions.html#mock-makers-mockito">mockito</a> Mock Maker.</p>
</li>
<li>
<p><a href="#global-groovy-mock-static-methods">Global Groovy mocks</a>: Work only for Groovy code not for Java.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="static-mocks"><a class="anchor" href="#static-mocks"></a><a class="link" href="#static-mocks">Static Mocks</a></h3>
<div class="paragraph">
<p>You can create static mocks with <code>SpyStatic()</code>.</p>
</div>
<div class="paragraph">
<p><code>SpyStatic(&lt;Type&gt;)</code> mocks the static methods of the given type; by default, delegates all calls to the real static methods.
Supports both stubbing and mocking.</p>
</div>
<div class="paragraph">
<p>We are using the class <code>StaticClass</code> in the examples:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">Example static class used in the test examples</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">StaticClass</span> {
  <span class="directive">static</span> <span class="predefined-type">String</span> staticMethod() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">RealValue</span><span class="delimiter">&quot;</span></span>
  }

  <span class="directive">static</span> <span class="predefined-type">String</span> otherStaticMethod() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">OtherValue</span><span class="delimiter">&quot;</span></span>
  }
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy#L108" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We want to mock the method <code>staticMethod()</code>, so we can create a static mock for the <code>StaticClass</code> type:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">Mock static method of a class with SpyStatic()</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
SpyStatic(StaticClass)

<span class="key">expect</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">By default SpyStatic() will return the real value</span><span class="delimiter">&quot;</span></span>
StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="content">RealValue</span><span class="delimiter">&quot;</span></span>

<span class="key">when</span>:
<span class="keyword">def</span> result = StaticClass.staticMethod()

<span class="key">then</span>:
<span class="integer">1</span> * StaticClass.staticMethod() &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span>
result == <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy#L28" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also specify the answers after construction by defining the interactions as for a normal mock:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">Mock static method of a class with interactions</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
SpyStatic(StaticClass)
StaticClass.staticMethod() &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span>

<span class="key">expect</span>:
StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy#L45" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It is also possible to stub all static methods of a class like a <code>Stub</code> would do:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">Stub all static methods of a class with default interaction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
SpyStatic(StaticClass)
StaticClass._ &gt;&gt; _

<span class="key">expect</span>:
StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
StaticClass.otherStaticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy#L66" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The static mocks require a mock maker supporting static methods, e.g. <a href="extensions.html#mock-makers-mockito">mockito</a>.
See <a href="extensions.html#mock-makers">mock makers</a> table for mock makers supporting it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_static_mocks_and_threading"><a class="anchor" href="#_static_mocks_and_threading"></a><a class="link" href="#_static_mocks_and_threading">Static Mocks and Threading</a></h3>
<div class="paragraph">
<p>The static mocks are thread-local, so they do not interfere with concurrent test execution.
But this also means that a static mock will not be active, if your code under test will use other threads.</p>
</div>
<div class="paragraph">
<p>A static mock is activated on the thread, which created the mock, up until the feature execution ends.
You can activate all static mocks on a different thread by hand:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">Use static mocks in a different Thread</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
SpyStatic(StaticClass)
StaticClass.staticMethod() &gt;&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span>

<span class="key">when</span>:
<span class="keyword">def</span> executor = <span class="predefined-type">Executors</span>.newSingleThreadExecutor()
<span class="keyword">def</span> wasCalled = <span class="predefined-constant">false</span>
<span class="keyword">def</span> future = executor.submit {
  <span class="keyword">assert</span> StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="content">RealValue</span><span class="delimiter">&quot;</span></span>

  withActiveThreadAwareMocks {
    <span class="comment">//Now the static methods of StaticClass are mocked:</span>
    <span class="keyword">assert</span> StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span>
    wasCalled = <span class="predefined-constant">true</span>
  }

  <span class="keyword">assert</span> StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="content">RealValue</span><span class="delimiter">&quot;</span></span>
}
future.get()

<span class="key">then</span>:
StaticClass.staticMethod() == <span class="string"><span class="delimiter">&quot;</span><span class="content">MockValue</span><span class="delimiter">&quot;</span></span>
wasCalled

<span class="key">cleanup</span>:
executor.shutdown()</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy#L78" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/StaticSpyDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>spock.mock.MockingApi</code> provides methods to activate a static mock on other threads:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>runWithThreadAwareMocks(Runnable)</code></p>
</li>
<li>
<p><code>withActiveThreadAwareMocks(Callable)</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="GroovyMocks"><a class="anchor" href="#GroovyMocks"></a><a class="link" href="#GroovyMocks">Groovy Mocks</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, all the mocking features we have seen work the same no matter if the calling code is written in Java or Groovy.
By leveraging Groovy&#8217;s dynamic capabilities, Groovy mocks offer some additional features specifically for testing Groovy code.
They are created with the <code>MockingApi.GroovyMock()</code>, <code>MockingApi.GroovyStub()</code>, and <code>MockingApi.GroovySpy()</code> factory methods.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When Should Groovy Mocks be Favored over Regular Mocks?
Groovy mocks should be used when the code under specification is written in Groovy <em>and</em> some of the unique Groovy
mock features are needed. When called from Java code, Groovy mocks will behave like regular mocks. Note that it
isn&#8217;t necessary to use a Groovy mock merely because the code under specification and/or mocked type is written
in Groovy. Unless you have a concrete reason to use a Groovy mock, prefer a regular mock.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_mocking_dynamic_methods"><a class="anchor" href="#_mocking_dynamic_methods"></a><a class="link" href="#_mocking_dynamic_methods">Mocking Dynamic Methods</a></h3>
<div class="paragraph">
<p>All Groovy mocks implement the <code>GroovyObject</code> interface. They support the mocking and stubbing of
dynamic methods as if they were physically declared methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Subscriber subscriber = GroovyMock()

<span class="integer">1</span> * subscriber.someDynamicMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="MockingAllInstancesOfAType"><a class="anchor" href="#MockingAllInstancesOfAType"></a><a class="link" href="#MockingAllInstancesOfAType">Mocking All Instances of a Type</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usually, Groovy mocks need to be injected into the code under specification just like regular mocks.
However, when a Groovy mock is created as <em>global</em>, it automagically replaces all real instances
of the mocked type for the duration from mock creation up until the end of the feature method:<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
<span class="keyword">def</span> publisher = <span class="keyword">new</span> Publisher()
<span class="keyword">def</span> anySubscriber = GroovySpy(<span class="key">global</span>: <span class="predefined-constant">true</span>, RealSubscriber)
publisher.subscribers.add(<span class="keyword">new</span> RealSubscriber())
publisher.subscribers.add(<span class="keyword">new</span> RealSubscriber())

<span class="key">when</span>:
publisher.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>)

<span class="key">then</span>:
<span class="integer">2</span> * anySubscriber.receive(<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/GlobalMockDocSpec.groovy#L34" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/GlobalMockDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here, we set up the publisher with two instances of a real subscriber implementation.
Then we create a global mock of the <em>same</em> type. This reroutes all method calls on the
real subscribers to the mock object. The mock object&#8217;s instance isn&#8217;t ever passed to the publisher;
it is only used to describe the interaction.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A global mock can only be created for a class type. It effectively replaces
all instances of that type for the duration from mock creation up until the end of the feature method.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Using global mocks for standard types from the JDK, for example <code>ArrayList</code>, is a bad idea and can lead to unforeseen and widespread consequences.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The declaration order of global mocks is relevant.
         The <code>GroovySpy(global:true, &lt;type&gt;)</code> must come before all creations of new mocked/spied objects of <code>&lt;type&gt;</code>.
         The global spies will only take effect on objects of that type, if the <code>GroovySpy(global:true, &lt;type&gt;)</code> was
         executed before the <code>new &lt;type&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since global mocks have a somewhat, well, global effect, it&#8217;s often convenient
to use them together with <code>GroovySpy</code>. This leads to the real code getting
executed <em>unless</em> an interaction matches, allowing you to selectively listen
in on objects and change their behavior just where needed.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
When using <code>GroovyMock(global:true)</code> it will also replace constructor calls, which will return <code>null</code> by default.
         If you want working real constructors, please use <code>GroovySpy</code> instead.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">GroovyMock(global) will also replace constructors</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
GroovyMock(<span class="key">global</span>: <span class="predefined-constant">true</span>, RealSubscriber)
<span class="key">when</span>:
<span class="keyword">def</span> sub = <span class="keyword">new</span> RealSubscriber()
<span class="key">then</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The GroovyMock(global: true) will also mock the constructor</span><span class="delimiter">&quot;</span></span>
sub == <span class="predefined-constant">null</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/GlobalMockDocSpec.groovy#L50" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/GlobalMockDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you want, that the real constructors are called:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="title">GroovyMock(global), but using the real constructors</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">given</span>:
GroovyMock(<span class="key">global</span>: <span class="predefined-constant">true</span>, RealSubscriber) {
  <span class="comment">//Allow that the real constructor is called</span>
  <span class="keyword">new</span> RealSubscriber(*_) &gt;&gt; { callRealMethod() }
}
<span class="key">when</span>:
<span class="keyword">def</span> sub = <span class="keyword">new</span> RealSubscriber()
<span class="key">then</span>:
sub <span class="keyword">instanceof</span> RealSubscriber</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/GlobalMockDocSpec.groovy#L61" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/GlobalMockDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>Specifications</code> or <code>Features</code> are executed concurrently you have to make sure that the <code>Features</code> which create
global mocks on the same types are properly guarded against each other, because a global mock changes the global state
for the mocked <code>Class</code> during execution.</p>
</div>
<div class="sect3">
<h4 id="global-mocks-parallel-execution"><a class="anchor" href="#global-mocks-parallel-execution"></a><a class="link" href="#global-mocks-parallel-execution">Global mocks and parallel execution</a></h4>
<div class="paragraph">
<p>Creating a global <code>GroovyMock</code>/<code>GroovyStub</code>/<code>GroovySpy</code> when <a href="parallel_execution.html#parallel-execution">parallel execution</a> is enabled,
requires that the spec is annotated with <a href="parallel_execution.html#isolated-execution">@Isolated</a> or <code>@ResourceLock(org.spockframework.runtime.model.parallel.Resources.META_CLASS_REGISTRY)</code>.
If it is only used for a feature, then it suffices that the feature is annotated with <code>@ResourceLock(org.spockframework.runtime.model.parallel.Resources.META_CLASS_REGISTRY)</code>.
The rule of thumb to choose between <code>@ResourceLock</code> and <code>@Isolated</code>, is to look at how widespread the mocked type is used.
If it is widely used, then <code>@Isolated</code> is the safe choice, otherwise <code>@ResourceLock</code> may be sufficient.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How Are Global Groovy Mocks Implemented?</div>
<div class="paragraph">
<p>Global Groovy mocks get their super powers from Groovy meta-programming. To be more precise,
every globally mocked type is assigned a custom <code>MetaClass</code> for the duration of the feature method.
Since a global Groovy mock is still based on a proxy class, it will retain its general mocking capabilities
(but not its super powers) when called from Java code.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="MockingConstructors"><a class="anchor" href="#MockingConstructors"></a><a class="link" href="#MockingConstructors">Mocking Constructors</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Global mocks support mocking of constructors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">RealSubscriber anySubscriber = GroovySpy(<span class="key">global</span>: <span class="predefined-constant">true</span>)

<span class="integer">1</span> * <span class="keyword">new</span> RealSubscriber(<span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we are using a spy, the object returned from the constructor call remains unchanged.
To change which object gets constructed, we can stub the constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> RealSubscriber(<span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="keyword">new</span> RealSubscriber(<span class="string"><span class="delimiter">&quot;</span><span class="content">Barney</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, whenever some code tries to construct a subscriber named Fred, we&#8217;ll construct
a subscriber named Barney instead.</p>
</div>
</div>
<div class="sect2">
<h3 id="global-groovy-mock-static-methods"><a class="anchor" href="#global-groovy-mock-static-methods"></a><a class="link" href="#global-groovy-mock-static-methods">Global Groovy Mocks for Static Methods</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Global mocks support mocking and stubbing of static methods in Groovy code.
If you want to mock static methods for Java code please use <a href="#static-mocks">Static Mocks</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">RealSubscriber anySubscriber = GroovySpy(<span class="key">global</span>: <span class="predefined-constant">true</span>)

<span class="integer">1</span> * RealSubscriber.someStaticMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>) &gt;&gt; <span class="integer">42</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same works for dynamic static methods.</p>
</div>
<div class="paragraph">
<p>When a global mock is used solely for mocking constructors and static methods,
the mock&#8217;s instance isn&#8217;t really needed. In such a case one can just write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">GroovySpy(RealSubscriber, <span class="key">global</span>: <span class="predefined-constant">true</span>)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Global mocks will only work for Groovy code under test not for Java code.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_features"><a class="anchor" href="#_advanced_features"></a><a class="link" href="#_advanced_features">Advanced Features</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the time you shouldn&#8217;t need these features. But if you do, you&#8217;ll be glad to have them.</p>
</div>
<div class="sect2">
<h3 id="ALaCarteMocks"><a class="anchor" href="#ALaCarteMocks"></a><a class="link" href="#ALaCarteMocks">A la Carte Mocks</a></h3>
<div class="paragraph">
<p>At the end of the day, the <code>Mock()</code>, <code>Stub()</code>, and <code>Spy()</code> factory methods are just canned ways to
create mock objects with a certain configuration. If you want more fine-grained control over a mock&#8217;s configuration,
have a look at the <code>org.spockframework.mock.IMockConfiguration</code> interface. All properties of this interface
<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup>
can be passed as named arguments to the <code>Mock()</code> method. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> person = Mock(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>, <span class="key">type</span>: Person, <span class="key">defaultResponse</span>: ZeroOrNullResponse.INSTANCE, <span class="key">verified</span>: <span class="predefined-constant">false</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we create a mock whose default return values match those of a <code>Mock()</code>, but whose invocations aren&#8217;t
verified (as for a <code>Stub()</code>). Instead of passing <code>ZeroOrNullResponse</code>, we could have supplied our own custom
<code>org.spockframework.mock.IDefaultResponse</code> for responding to unexpected method invocations.</p>
</div>
</div>
<div class="sect2">
<h3 id="DetectingMockObjects"><a class="anchor" href="#DetectingMockObjects"></a><a class="link" href="#DetectingMockObjects">Detecting Mock Objects</a></h3>
<div class="paragraph">
<p>To find out whether a particular object is a Spock mock object, use a <code>org.spockframework.mock.MockUtil</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">MockUtil mockUtil = <span class="keyword">new</span> MockUtil()
<span class="predefined-type">List</span> list1 = <span class="type">[]</span>
<span class="predefined-type">List</span> list2 = Mock()

<span class="key">expect</span>:
!mockUtil.isMock(list1)
mockUtil.isMock(list2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>An util can also be used to get more information about a mock object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">IMockObject mock = mockUtil.asMock(list2)

<span class="key">expect</span>:
mock.name == <span class="string"><span class="delimiter">&quot;</span><span class="content">list2</span><span class="delimiter">&quot;</span></span>
mock.type == <span class="predefined-type">List</span>
mock.nature == MockNature.MOCK</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="DetachedMockFactory"><a class="anchor" href="#DetachedMockFactory"></a><a class="link" href="#DetachedMockFactory">Create Mocks Outside Specifications</a></h3>
<div class="paragraph">
<p>Sometimes, it can be helpful to create and possibly preconfigure mock, stub or spy objects outside specifications, especially if you want to factor out duplicate or similar code from there.
Use <code>DetachedMockFactory</code> to create such mock objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Detached mocks, as the name implies, must be attached to a specification to make them functional.
      This either happens manually by calling <code>MockUtil.attachMock(Object, Specification)</code> or automatically by declaring the mock as an instance field with an <code>@AutoAttach</code> annotation, see <a href="extensions.html#_autoattach">AutoAttach</a>.
      While auto-attached mocks will also be auto-detached during specification clean-up, you need to take care of manually attached mocks by yourself, calling <code>MockUtil.detachMock(Object)</code> when they are no longer in use.
      Spring and Guice dependency injection will also automatically attach mocks, when the <code>SpringExtension</code> or <code>GuiceExtension</code> is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming that we have an application class <code>Car</code> and each car has an <code>Engine</code>:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Engine</span> {
  <span class="directive">private</span> <span class="type">boolean</span> started

  <span class="type">boolean</span> isStarted() { <span class="keyword">return</span> started }

  <span class="type">void</span> start() { started = <span class="predefined-constant">true</span> }

  <span class="type">void</span> stop() { started = <span class="predefined-constant">false</span> }
}

<span class="type">class</span> <span class="class">Car</span> {
  <span class="directive">private</span> Engine engine

  <span class="type">void</span> drive() { engine.start() }

  <span class="type">void</span> park() { engine.stop() }
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L156" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In our specification, we declare a detached mock factory and a mock util, either inside a feature method or, if we need them for multiple features, as (preferably) shared or (suboptimally) static instances:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Shared</span>
<span class="keyword">def</span> mockFactory = <span class="keyword">new</span> DetachedMockFactory()

<span class="annotation">@Shared</span>
<span class="keyword">def</span> mockUtil = <span class="keyword">new</span> MockUtil()</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L22" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_manually_attach_detach"><a class="anchor" href="#_manually_attach_detach"></a><a class="link" href="#_manually_attach_detach">Manually attach / detach</a></h4>
<div class="paragraph">
<p>Now in our feature, we create a detached <code>Engine</code> mock, attach the mock to the specification manually, stub its <code>isStarted()</code> method, inject the mock into a <code>Car</code> subject under specification, use the subject and finally detach the mock again after use:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Manually attach detached mock</span><span class="delimiter">&quot;</span></span>() {
  <span class="key">given</span>:
  <span class="keyword">def</span> manuallyAttachedEngine = mockFactory.Mock(Engine)
  mockUtil.attachMock(manuallyAttachedEngine, <span class="local-variable">this</span>)
  manuallyAttachedEngine.isStarted() &gt;&gt; <span class="predefined-constant">true</span>
  <span class="keyword">def</span> car = <span class="keyword">new</span> Car(<span class="key">engine</span>: manuallyAttachedEngine)

  <span class="key">when</span>:
  car.drive()

  <span class="key">then</span>:
  <span class="integer">1</span> * manuallyAttachedEngine.start()
  manuallyAttachedEngine.isStarted()

  <span class="key">when</span>:
  car.park()

  <span class="key">then</span>:
  <span class="integer">1</span> * manuallyAttachedEngine.stop()
  manuallyAttachedEngine.isStarted()

  <span class="key">cleanup</span>:
  mockUtil.detachMock(manuallyAttachedEngine)
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L30" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_use_autoattach"><a class="anchor" href="#_use_autoattach"></a><a class="link" href="#_use_autoattach">Use @AutoAttach</a></h4>
<div class="paragraph">
<p>Same situation, different approach:
We let Spock take care of automatically attaching the detached mock when starting the feature method and detaching it again after running the feature.</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@AutoAttach</span>
<span class="keyword">def</span> autoAttachedEngine = mockFactory.Mock(Engine)

<span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Auto-attach detached mock</span><span class="delimiter">&quot;</span></span>() {
  <span class="key">given</span>:
  autoAttachedEngine.isStarted() &gt;&gt; <span class="predefined-constant">true</span>
  <span class="keyword">def</span> car = <span class="keyword">new</span> Car(<span class="key">engine</span>: autoAttachedEngine)

  <span class="key">when</span>:
  car.drive()

  <span class="key">then</span>:
  <span class="integer">1</span> * autoAttachedEngine.start()
  autoAttachedEngine.isStarted()

  <span class="key">when</span>:
  car.park()

  <span class="key">then</span>:
  <span class="integer">1</span> * autoAttachedEngine.stop()
  autoAttachedEngine.isStarted()
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L57" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_pre_configure_detached_mock_with_default_response"><a class="anchor" href="#_pre_configure_detached_mock_with_default_response"></a><a class="link" href="#_pre_configure_detached_mock_with_default_response">Pre-configure detached mock with default response</a></h4>
<div class="paragraph">
<p>This advanced use case might only be of interest to a minority of users, you may skip it for now if you just want to learn Spock basics.</p>
</div>
<div class="paragraph">
<p>Usually, you would simply create your detached mock outside of Spock, but then define interactions (stubbed method results, method call verifications) inside the feature method itself.
Sometimes however, you might want to define some (user-overridable) default behaviour right in the detached mock definition itself and even make it somewhat configurable.</p>
</div>
<div class="paragraph">
<p>A valid use case could be a detached mock used in a dependency injection framework like Spring or Guice.
The framework might wire the mock and rely on some default behaviour, before Spock even gets a chance to stub any methods.
Defining default behaviour is possible using a combination of Spock&#8217;s mocking API and custom <code>IDefaultResponse</code> implementations.</p>
</div>
<div class="paragraph">
<p>A custom detached mock creator could look like this (please figure out by yourself what it does and how it works):</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">EngineMockCreator</span> {
  <span class="type">enum</span> StartMode {
    ALWAYS_STARTED, ALWAYS_STOPPED, RANDOMLY_STARTED, REAL_RESPONSE
  }

  <span class="directive">static</span> DetachedMockFactory mockFactory = <span class="keyword">new</span> DetachedMockFactory()

  <span class="directive">static</span> <span class="type">class</span> <span class="class">EngineStateResponse</span> <span class="directive">implements</span> IDefaultResponse {
    StartMode startMode

    <span class="annotation">@Override</span>
    <span class="predefined-type">Object</span> respond(IMockInvocation invocation) {
      <span class="keyword">if</span> (invocation.method.name != <span class="string"><span class="delimiter">'</span><span class="content">isStarted</span><span class="delimiter">'</span></span>)
        <span class="keyword">return</span> ZeroOrNullResponse.INSTANCE.respond(invocation)
      startMode == RANDOMLY_STARTED
        ? ThreadLocalRandom.current().nextBoolean()
        : startMode == ALWAYS_STARTED
    }
  }

  <span class="directive">static</span> Engine getMock(StartMode startMode) {
    startMode == REAL_RESPONSE
      ? mockFactory.Spy(<span class="keyword">new</span> Engine())
      : mockFactory.Mock(Engine, <span class="key">defaultResponse</span>: <span class="keyword">new</span> EngineStateResponse(<span class="key">startMode</span>: startMode)) <span class="keyword">as</span> Engine
  }
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L181" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The first parametrized feature uses the mock without attach:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Unroll</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Engine state #engineStateResponseType</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Mock usage without manually attach detach with preconfigured engine state</span><span class="delimiter">&quot;</span></span>() {
  <span class="key">given</span>:
  <span class="keyword">def</span> car = <span class="keyword">new</span> Car(<span class="key">engine</span>: preconfiguredEngine)
  <span class="comment">// The preconfigured mock with default behaviour behaves as defined,</span>
  <span class="comment">// even *without* attaching it to the spec.</span>

  <span class="key">when</span>:
  car.drive()

  <span class="key">then</span>:
  possibleResponsesAfterStart.contains(preconfiguredEngine.isStarted())

  <span class="key">when</span>:
  car.park()

  <span class="key">then</span>:
  possibleResponsesAfterStop.contains(preconfiguredEngine.isStarted())

  <span class="key">where</span>:
  engineStateResponseType | possibleResponsesAfterStart | possibleResponsesAfterStop
  ALWAYS_STARTED          | [<span class="predefined-constant">true</span>]                      | [<span class="predefined-constant">true</span>]
  ALWAYS_STOPPED          | [<span class="predefined-constant">false</span>]                     | [<span class="predefined-constant">false</span>]
  RANDOMLY_STARTED        | [<span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>]               | [<span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>]
  REAL_RESPONSE           | [<span class="predefined-constant">true</span>]                      | [<span class="predefined-constant">false</span>]
  preconfiguredEngine = EngineMockCreator.getMock(engineStateResponseType)
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L82" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The next parametrized feature method showcasing a set of usage scenarios when a detached mock
is attached to a spec before usage:</p>
</div>
<table class="tableblock frame-none grid-none stretch includeSourceLinkerTable">
<colgroup>
<col style="width: 100%;">
<col style="width: 0%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Unroll</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Engine state #engineStateResponseType</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Manually attach detached mock with preconfigured engine state</span><span class="delimiter">&quot;</span></span>() {
  <span class="key">given</span>:
  <span class="keyword">def</span> car = <span class="keyword">new</span> Car(<span class="key">engine</span>: preconfiguredEngine)
  <span class="comment">//Now, let's attach the mock to the spec and override its default behaviour.</span>
  mockUtil.attachMock(preconfiguredEngine, <span class="local-variable">this</span>)
  preconfiguredEngine.isStarted() &gt;&gt; <span class="predefined-constant">true</span>

  <span class="key">expect</span>:
  preconfiguredEngine.isStarted()
  <span class="comment">// The attached mock now behaves differently. Because it has been attached to the</span>
  <span class="comment">// spec, we can also verify interactions using '1 * ...' or similar, which</span>
  <span class="comment">// would not be possible without attaching it.</span>

  <span class="key">when</span>:
  car.drive()

  <span class="key">then</span>:
  <span class="integer">1</span> * preconfiguredEngine.start()
  preconfiguredEngine.isStarted()

  <span class="key">when</span>:
  car.park()

  <span class="key">then</span>:
  <span class="integer">1</span> * preconfiguredEngine.stop()
  preconfiguredEngine.isStarted()

  <span class="key">cleanup</span>:
  mockUtil.detachMock(preconfiguredEngine)

  <span class="key">where</span>:
  engineStateResponseType | possibleResponsesAfterStart | possibleResponsesAfterStop
  ALWAYS_STARTED          | [<span class="predefined-constant">true</span>]                      | [<span class="predefined-constant">true</span>]
  ALWAYS_STOPPED          | [<span class="predefined-constant">false</span>]                     | [<span class="predefined-constant">false</span>]
  RANDOMLY_STARTED        | [<span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>]               | [<span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>]
  REAL_RESPONSE           | [<span class="predefined-constant">true</span>]                      | [<span class="predefined-constant">false</span>]
  preconfiguredEngine = EngineMockCreator.getMock(engineStateResponseType)
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><sup><span class="icon"><a class="image" href="https://github.com/spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy#L113" target="_blank" rel="noopener"><i class="fa fa-github fa-2x"></i></a></span></sup>
<sup><span class="icon"><a class="image" href="https://groovyconsole.dev?github=spockframework/spock/blob/74e99402a33f1f3a6c5b7a6fdf7b394d44f0b5f5/spock-specs/src/test/groovy/org/spockframework/docs/interaction/DetachedMockFactoryDocSpec.groovy" target="_blank" rel="noopener"><i class="fa fa-play fa-2x"></i></a></span></sup></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading"><a class="anchor" href="#_further_reading"></a><a class="link" href="#_further_reading">Further Reading</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you would like to dive deeper into interaction-based testing, we recommend the following resources:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://www.ccs.neu.edu/research/demeter/related-work/extreme-programming/MockObjectsFinal.PDF">Endo-Testing: Unit Testing with Mock Objects</a></dt>
<dd>
<p>Paper from the XP2000 conference that introduces the concept of mock objects.</p>
</dd>
<dt class="hdlist1"><a href="https://www.jmock.org/oopsla2004.pdf">Mock Roles, not Objects</a></dt>
<dd>
<p>Paper from the OOPSLA2004 conference that explains how to do mocking <em>right</em>.</p>
</dd>
<dt class="hdlist1"><a href="https://martinfowler.com/articles/mocksArentStubs.html">Mocks Aren&#8217;t Stubs</a></dt>
<dd>
<p>Martin Fowler&#8217;s take on mocking.</p>
</dd>
<dt class="hdlist1"><a href="https://www.growing-object-oriented-software.com">Growing Object-Oriented Software Guided by Tests</a></dt>
<dd>
<p>TDD pioneers Steve Freeman and Nat Pryce explain in detail how test-driven development and mocking work in the real world.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. For additional ways to create mock objects, see <a href="#OtherKindsOfMockObjects">Other Kinds of Mock Objects</a> and <a href="#ALaCarteMocks">A la Carte Mocks</a>.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The <code>subscriber</code> variable cannot be referenced from the closure because it is being declared as part of the same statement.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. The destructuring semantics for closure arguments come straight from Groovy.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. You may know this behavior from Groovy&#8217;s <a href="https://docs.groovy-lang.org/docs/groovy-4.0.13/html/gapi/groovy/mock/interceptor/MockFor.html">MockFor</a> and <a href="https://docs.groovy-lang.org/docs/groovy-4.0.13/html/gapi/groovy/mock/interceptor/StubFor.html">StubFor</a> facilities.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. Because mock configurations are immutable, the interface contains just the properties' getters.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.4-SNAPSHOT<br>
Last updated 2024-04-19 16:16:06 UTC
</div>
</div>
</body>
</html>