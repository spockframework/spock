name: 'Verify Branches and PRs'

on:
  push:
    branches-ignore:
      - master
      - gh-pages
  pull_request:
    branches:
      - '*'

concurrency:
  # On master/release, we don't want any jobs cancelled so the sha is used to name the group
  # On PR branches, we cancel the job if new commits are pushed
  # More info: https://stackoverflow.com/a/68422069/253468
  group: ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/release' ) && format('ci-main-{0}', github.sha) || format('ci-main-{0}', github.ref) }}
  cancel-in-progress: true

jobs:
  matrix_prep:
    name: Matrix Preparation
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    env:
      MATRIX_JOBS: 7
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 50
      - id: set-matrix
        run: |
          node .github/workflows/matrix.js

  build-and-verify:
    needs: matrix_prep
    name: '${{ matrix.name }}'
    runs-on: ${{ matrix.os }}
    env:
      TZ: ${{ matrix.tz }}
    strategy:
      matrix: ${{fromJson(needs.matrix_prep.outputs.matrix)}}
      fail-fast: false
      # max-parallel: 4
    steps:
      - uses: actions/checkout@v2
        with:
          # Codecov needs fetch-depth > 1
          fetch-depth: 2
      - name: 'Set up JDK ${{ matrix.java }}'
        uses: actions/setup-java@v2
        if: matrix.java != 8
        with:
          distribution: ${{ matrix.java_distribution }}
          java-version: ${{ matrix.java }}
      - name: 'Prepare JDK${{ matrix.java }} env var'
        shell: bash
        run: echo "JDK${{ matrix.java }}=$JAVA_HOME" >> $GITHUB_ENV
      - name: 'Set up JDK 8'
        uses: actions/setup-java@v2
        with:
          java-version: 8
          cache: 'gradle'
          distribution: ${{ matrix.java8_distribution }}
      - name: Prepare JDK8 env var
        shell: bash
        run: echo "JDK8=$JAVA_HOME" >> $GITHUB_ENV
      - name: 'Gradle Version'
        run: |
          ./gradlew --version
          ./gradlew javaToolchains
      - name: 'Build Spock'
        # secrets are not injected for pull requests
        env:
          ORG_GRADLE_PROJECT_spockBuildCacheUsername: ${{ secrets.SPOCK_BUILD_CACHE_USERNAME }}
          ORG_GRADLE_PROJECT_spockBuildCachePassword: ${{ secrets.SPOCK_BUILD_CACHE_PASSWORD }}
          GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
          _JAVA_OPTIONS: ${{ matrix.testExtraJvmArgs }}
        run: |
          ./gradlew --no-parallel --stacktrace ghActionsBuild "-Dvariant=${{ matrix.variant }}" "-DjavaVersion=${{ matrix.java }}"
      - name: 'Stop Daemon'
        run: |
          ./gradlew --stop
      - name: 'Upload to Codecov.io'
        uses: codecov/codecov-action@v2
